#!/usr/bin/env Rscript
#
# This script generates .Rd files for a list of chosen auto-generated S4 classes
# can be invoked from a shell script, e.g.:
# path/to/package/source/inst/docGen/autoGeneratedRdFiles.R path/to/package/source
# 
# Author: brucehoff
###############################################################################

##------
# copied from AAASchema.R
# ideally we'd abstract this functionality from the Synapse Client so it would only be in one place

##-----

readSchema<-function(schemaName) {
  file <- sprintf("%s.json", gsub("[\\.]", "/", name))
  
}
# This generates one .Rd file for an auto-generated S4 class using its JSON schema
createRdFromSchema<-function(className, schemaName, schemaPath, classToSchemaMap) {
  nameLine<-paste("\\name{", className, "}", sep="")
  aliasLine<-paste("\\alias{", className, "}", sep="")
  docTypeLine<-paste("\\docType{methods}", sep="")
  titleLine<-paste("\\title{\n", className, " Constructor\n}", sep="")
  descriptionLine<-paste("\\description{Constructor for ", className, "}", sep="")
  
  propertySchemas<-getEffectivePropertySchemas(schemaName)
  usageLine<-paste("\\usage{", className, "(", paste(names(propertySchemas), collapse=", "), ")}", sep="")
  
  arguments<-"\\arguments{"
  for (propertyName in names(propertySchemas)) {
    arguments<-paste(arguments, 
      itemRdEntry(propertyName, propertySchemas[[propertyName]]$description), sep="\n")
  }
  arguments<-paste(arguments, "}", sep="\n")
  slots<-"\\section{Slots}{\n  \\describe{"
  for (propertyName in names(propertySchemas)) {
    slots<-paste(slots, slotRdEntry(propertyName, propertySchemas[[propertyName]]$description), sep="\n")
  }
  slots<-paste(slots, "  }\n}", sep="\n")
  seealso<-"\\seealso{"
  for (property in propertySchemas) {
    if (!is.null(property[["$ref"]])) {
      referencedClass<- classToSchemaMap(property[["$ref"]])
      if (!is.null(referencedClass)) {
        seealso<-paste(seealso, paste("\\code{\\link{",referencedClass, "}}", sep=""), sep="\n")
      }
    }
  }
  seealso<-paste(seealso, "}", sep="\n")
  result<-paste(
    nameLine, 
    aliasLine, 
    docTypeLine, 
    titleLine, 
    usageLine,
    arguments,
    slots,
    seealso,
    sep="\n")
  
  result
}

itemRdEntry<-function(itemName, itemDescription) {
  paste("  \\item{", itemName, "}{\n  ", itemDescription, "\n  }", sep="")
}

slotRdEntry<-function(itemName, itemDescription) {
  paste("    \\item{\\code{", itemName, "}}{\n    ", itemDescription, "\n    }", sep="")
}

# create the autogenerated files
# srcRootDir is the root directory for the code base
# the schemas are found in <srcRootDir>/inst/resources/schema
# the target dir is <srcRootDir>/man
autoGenerateRdFiles<-function(srcRootDir) {
  if (!file.exists(srcRootDir)) {
    stop(sprintf("%s does not exist.", srcRootDir))
  }
  filePath<-sprintf("%s/inst/resources/s4ClassesToGenerate.txt", srcRootDir)
  s4ClassesToAutoGenerate<-read.table(filePath,
    header=TRUE, colClasses=c("character", "character", "logical"))
  schemaPath<-sprintf("%s/inst/resources/schema", scrRootDir)
  classToSchemaMap<-list()
  for(i in 1:(dim(s4ClassesToAutoGenerate)[1])) { 
    schemaName<-s4ClassesToAutoGenerate[i,"schemaName"]
    className<-s4ClassesToAutoGenerate[i,"className"]
    classToSchemaMap[[schemaName]]<-className
  }
  for(i in 1:(dim(s4ClassesToAutoGenerate)[1])) { 
    schemaName<-s4ClassesToAutoGenerate[i,"schemaName"]
    className<-s4ClassesToAutoGenerate[i,"className"]
    if (s4ClassesToAutoGenerate[i,"genDoc"]) {
      rdContent<-createRdFromSchema(className, schemaName, schemaPath, classToSchemaMap)
      connection<-file(sprintf("%s/man/%s.Rd", srcRootDir, className))
      writeChar(rdContent, connection, eos=NULL)
      close(connection)
    }
  }
}

# now call autoGenerateRdFiles
args <- commandArgs(TRUE)
srcRootDir<-args[1]
# 'source' some functions shared with the synapse client package
source(sprintf("%s/R/AAAAshared.R",srcRootDir))
autoGenerateRdFiles(srcRootDir)
